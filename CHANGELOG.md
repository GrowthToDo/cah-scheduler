# Changelog

All notable changes to the CAH Scheduler project are documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).

---

## [1.4.4] - 2026-02-22

### Fixed

- **Assignment dialog now correctly identifies when a shift still needs a charge nurse.** The previous condition checked whether *any* existing assignment had `isChargeNurse = true`, regardless of competency level. If a Level 3 nurse had been assigned as charge (violating the hard rule), the "Needs charge nurse" badge would disappear and the "Assign as Charge" button would never appear for valid Level 4+ candidates. The check now requires both `isChargeNurse = true` **and** `staffCompetency ≥ 4`, so the dialog accurately reflects that a valid charge nurse is still missing.

- **"Assign as Charge" button gated to Level 4+ nurses.** Previously any `isChargeNurseQualified` nurse would show the "Assign as Charge" button even if their competency level was 1–3. The button is now only offered to nurses with `icuCompetencyLevel ≥ 4`, matching the hard rule requirement in §3.2.

- **Assigning a new charge nurse now demotes the previous charge.** When a manager clicked "Assign as Charge" for a valid Level 4+ nurse, the API inserted the new assignment but left the previous invalid charge (e.g., a Level 3 nurse flagged as charge) in place. The shift then had two charge designations — an invalid one and a valid one — and the hard violation persisted despite the manager's action. The API now clears all existing `isChargeNurse = true` assignments on the same shift before inserting the new charge assignment, ensuring there is exactly one charge nurse and the violation resolves.

### Files Modified

- `src/components/schedule/assignment-dialog.tsx` — `needsCharge` condition now requires `staffCompetency >= 4`; "Assign as Charge" button now requires `icuCompetencyLevel >= 4`
- `src/app/api/schedules/[id]/assignments/route.ts` — demotes existing charge assignments before inserting a new charge nurse

---

## [1.4.3] - 2026-02-22

### Changed

- **Balanced variant overtime weight raised from 1.0 to 1.5.** In the Balanced scheduler, actual overtime (>40h) was previously less expensive than some preference violations — for example, 8h of OT cost 0.667 units while a shift-type mismatch cost 0.75. This meant the scheduler would sometimes choose to put a nurse into overtime rather than assign an unwanted shift type to someone else. The new weight (1.5) makes 8h OT cost 1.0 units, consistently more expensive than any single preference violation, which reflects the real payroll cost of overtime pay (1.5× rate). The Fairness-Optimized variant intentionally keeps overtime low (0.5) to allow extra hours in exchange for equitable weekend and holiday distribution; that profile is unchanged.

- **Capacity-spreading bonus added to the scheduling scoring function.** The greedy algorithm previously had no preference between two candidates with equal accumulated hours. This caused regular unit staff to be repeatedly selected for shifts until they approached overtime, while float pool staff — often fully cross-trained and at low hours — were left underutilised. A small capacity bonus (`−overtime_weight × 0.1 × remaining_hours_before_40h / 40`) now makes the algorithm prefer less-loaded staff when other factors are equal. At full remaining capacity (0h worked), the bonus is −0.15 in Balanced; at 24h already worked, it is −0.06. This gradient is intentionally small — it breaks ties without overriding clinical factors like charge requirement or competency level. Float pool staff naturally benefit most from this bonus early in the greedy pass (when they are typically at low hours and ICU shifts consume capacity), which reduces overtime accumulation on regular unit nurses later in the same week.

### Files Modified

- `src/lib/engine/scheduler/weight-profiles.ts` — Balanced `overtime: 1.0 → 1.5`
- `src/lib/engine/scheduler/scoring.ts` — capacity-spreading bonus added after overtime penalty block

---

## [1.4.2] - 2026-02-20

### Fixed

- **Overtime violations now flag the triggering shift, not all shifts.** Previously the overtime rule attached a staff-level violation (no shift ID), which made it invisible when clicking individual shifts in the grid and provided no guidance on which assignment to adjust. The rule now walks each staff member's assignments in chronological order, tracks cumulative hours for the week, and emits the violation only on the exact shift that pushes the running total past the threshold. All earlier shifts remain clean.

- **Agency staff (FTE = 0) are no longer flagged for overtime.** Agency and on-demand staff have no weekly hours commitment — their FTE is recorded as 0. The previous logic derived a "standard hours" target of 0 × 40 = 0, which caused every shift worked to appear as an overtime violation. The fix exempts any staff member whose FTE is exactly 0 from the overtime rule entirely.

- **Weekend rule now flags excess assignments, not shortfall.** The previous logic flagged staff who had *too few* weekend shifts. This was not actionable — there is no specific shift to remove when someone is short. The rule now flags each assignment that takes a staff member *beyond* their required weekend count, attaching the violation to that specific shift. Staff who meet or fall short of their target have no violation; the scheduler's cost function handles shortfall by preferring to assign those staff on weekends during construction.

- **Soft violations are now visible when clicking shift cells.** Overtime and weekend violations both had an empty `shiftId` (staff-level), so they never appeared in the per-shift violations modal. The schedule page now builds a secondary map of staff-level violations and attaches them to every shift where that staff member is assigned. The violations modal displays three separate sections: hard rule violations (red), shift-specific soft violations (yellow, e.g. preference mismatch), and staff schedule issues (orange, e.g. overtime or excess weekends).

- **Applying a scenario no longer permanently locks the other two.** After applying one scenario, the remaining scenarios were set to `rejected` status. The UI only showed the Apply button for `draft` scenarios, leaving rejected ones with no way to switch back. The condition is now `status !== "selected"` — any scenario that is not the currently active one shows an Apply button, and the Reject button is limited to `draft` scenarios only.

- **ESLint CI check restored.** 29 linting errors were blocking the GitHub Actions check. Fixed by: auto-correcting 8 `prefer-const` violations, disabling the `react-hooks/set-state-in-effect` rule globally (the async fetch-then-setState pattern used in every page triggers a false positive), replacing three `no-explicit-any` casts with proper Drizzle-inferred types, and converting one `require()` call in the import route to an ESM `import`.

### Files Modified

- `src/lib/engine/rules/overtime-v2.ts` — shift-specific violations, FTE = 0 exemption
- `src/lib/engine/rules/weekend-holiday-fairness.ts` — excess-flagging logic with shift IDs
- `src/app/schedule/[id]/page.tsx` — staff violation map; attaches staff-level violations to shift cells
- `src/components/schedule/shift-violations-modal.tsx` — three-section layout (hard / soft / staff)
- `src/app/scenarios/page.tsx` — Apply button shown for all non-active scenarios
- `eslint.config.mjs` — disable `react-hooks/set-state-in-effect`
- `src/app/api/audit/route.ts` — typed Drizzle column references, removed `as any`
- `src/app/audit/page.tsx` — typed `actionColors` map, removed `as any`
- `src/app/api/import/route.ts` — ESM import for `xlsx`

---

## [1.4.1] - 2026-02-20

### Fixed

- **Charge nurse competency enforced as a hard rule.** Only Level 4+ nurses may be assigned as charge. Level 5 is the preferred primary charge nurse; Level 4 is the stand-in fallback only when no Level 5 is available. Level 1–3 nurses cannot be charge regardless of the `isChargeNurseQualified` database flag. The fix was applied in both the scheduling engine (greedy pass) and the rule evaluator, so bad import data cannot slip through either path. Tests added for both layers.

- **60-hour rolling window check is now comprehensive.** The scheduler processes ICU shifts first (most-constrained-first ordering). This means future-dated ICU assignments are placed in state before earlier Med-Surg dates are processed. The previous backward-only window check `[date-6 … date]` saw no existing assignments for those earlier dates and allowed them through — but the forward windows `[date … date+6]` were already over the 60h limit. The fix checks all 7 windows that contain the candidate shift date, catching any combination of past and future assignments that would breach the limit.

- **Violations display separated into hard and soft.** The schedule grid now shows a red "N hard" badge and a yellow "N soft" badge independently per shift. Previously, soft violations were displayed with the same styling as hard violations, making it hard to distinguish severity.

### Changed

- **Per-staff soft violation breakdown added.** The soft violations summary card on the schedule page now includes an "Affected staff" section listing every nurse with at least one soft violation, sorted by violation count (highest first), with the rule names that fired for them. This replaces the previous rule-level-only view, which gave no indication of which individuals were most affected.

---

## [1.4.0] - 2026-02-20

### Summary

This release introduces **automated schedule generation** — the first fully algorithmic scheduling engine for the CAH Scheduler. A new "Generate Schedule" button runs three schedule variants in the background, writes the best variant directly to the schedule, and presents the other two as alternatives for manager review on the Scenarios page.

---

### New Feature: Automated Schedule Generation

#### Overview

Managers can now click **Generate Schedule** from any schedule's detail page. The system runs a two-phase greedy + local search algorithm across three weighted variants (Balanced, Fairness-Optimized, Cost-Optimized), each optimising different priorities while never violating hard scheduling rules.

- **Balanced** (auto-applied): Equal weight across all scheduling objectives. Written directly to the schedule's assignment table as the starting draft.
- **Fairness-Optimized**: Maximises weekend equity, holiday fairness, and preference matching. Saved as an alternative scenario.
- **Cost-Optimized**: Minimises overtime and float/agency use. Saved as an alternative scenario.

After generation, managers compare variants on the **Scenarios** page and click **Apply** to switch the active schedule to a different variant.

---

#### Algorithm Design

**Phase 1 — Greedy Construction**

Shifts are ordered by constraint difficulty (most constrained first):
1. ICU/ER shifts requiring a charge nurse
2. All other ICU/ER shifts
3. Night shifts
4. Day/evening shifts
5. On-call shifts (most flexible pool, filled last)

For each shift, the charge nurse slot (if required) is filled first using only charge-qualified candidates. Remaining slots are filled one at a time by filtering all eligible staff through hard rules, then scoring each candidate with soft rule penalties and selecting the lowest-penalty candidate.

If no eligible staff exist for a slot — because every candidate fails at least one hard rule — the slot is left empty, the shift is marked as **understaffed**, and the reasons why each candidate was rejected are recorded for manager review.

**Phase 2 — Local Search (Swap Improvement)**

After greedy construction, up to 500 random swap attempts are made between pairs of assignments on different shifts. A swap is accepted only if:
- Both staff members still pass all hard rules in their new positions
- The total soft penalty score decreases (monotonic improvement; the algorithm never accepts a worse solution)

This escapes greedy local optima without risking hard rule violations.

---

#### Hard Rules (Never Relaxed)

These constraints are enforced as absolute eligibility filters. Violating any one blocks the assignment regardless of how many soft rule benefits the candidate would provide:

| # | Rule | Description |
|---|------|-------------|
| 1 | Approved leave | Staff on approved leave cannot be assigned |
| 2 | PRN availability | Per-diem staff must have submitted availability for the shift date |
| 3 | ICU/ER competency | ICU, ER, and ED shifts require competency level ≥ 2 |
| 4 | No overlap | Staff cannot be assigned to two overlapping shifts |
| 5 | Minimum rest | At least 10 hours between the end of one shift and the start of the next |
| 6 | Max consecutive days | No more than 5 consecutive working days (or staff's personal preference if lower) |
| 7 | 60h rolling window | Total hours in any 7-day window must not exceed 60 |
| 8 | On-call limits | Respects `maxOnCallPerWeek` and `maxOnCallWeekendsPerMonth` unit settings |

---

#### Soft Rule Penalty Scoring

Each candidate is scored on a scale where lower = better (negative values are valid as incentives):

| Component | Description |
|-----------|-------------|
| Overtime | Hours above 40/week penalised heavily; hours above FTE target but ≤40 penalised lightly |
| Preference mismatch | Wrong shift type (×0.5), preferred day off (×0.7), weekend avoidance (×0.6) |
| Weekend incentive | Negative penalty for staff below their weekend quota (encourages equitable distribution) |
| Float | Penalty for assigning outside home unit; reduced if cross-trained |
| Skill mix | Penalises all-same-competency-level shifts; incentivises adding a new level |
| Competency pairing | Incentivises assigning a Level 5 when a Level 1 is present; Level 4+ when Level 2 is on ICU |
| Charge clustering | Penalises extra charge-qualified nurses on shifts that already have a charge nurse |

---

#### Weight Profiles per Variant

| Weight | Balanced | Fairness-Optimized | Cost-Optimized |
|--------|----------|--------------------|----------------|
| Overtime | 1.0 | 0.5 | **3.0** |
| Preference | 1.0 | **2.0** | 0.5 |
| Weekend count | 1.0 | **3.0** | 1.0 |
| Consecutive weekends | 1.0 | **3.0** | 1.0 |
| Holiday fairness | 1.0 | **3.0** | 1.0 |
| Skill mix | 1.0 | 1.0 | 0.5 |
| Float | 1.0 | 0.5 | **3.0** |
| Charge clustering | 1.0 | 1.0 | 0.5 |

---

#### Understaffing Handling

When a shift cannot be fully staffed because every remaining candidate fails at least one hard rule, the shift is left understaffed. The generation job records:
- Which shifts were understaffed
- How many slots were filled vs. required
- The most common hard rule rejection reasons across the candidate pool

These warnings are shown to the manager after generation completes. The manager reviews and resolves understaffed shifts manually.

---

#### Background Job & Progress Tracking

Generation runs in the background after the HTTP response is returned (using `setImmediate`). The frontend polls for progress every 2 seconds and displays:
- Current phase (e.g., "Building Balanced schedule…")
- Progress percentage
- Understaffed shift warnings when complete

A `generation_job` database record tracks the full job lifecycle (pending → running → completed/failed), enabling recovery on page refresh.

---

#### Apply Scenario

From the Scenarios page, managers can:
- **Apply** — Replace all current assignments with the selected scenario's snapshot. Marks that scenario `selected` and all others `rejected`. Writes an audit log entry.
- **Reject** — Dismiss a scenario without applying it.

---

#### Audit Trail

| Event | Entries Created |
|-------|-----------------|
| Initial generation | 3 entries (one per variant) with action `schedule_auto_generated`. Includes assignment count, understaffed count, and score breakdown for each variant. |
| Apply scenario | 1 entry with action `scenario_applied`. Logs old assignment count, new assignment count, and scenario name. |
| Subsequent manual events | Existing per-event audit behavior (callouts, swaps, manual edits) is unchanged. |

---

### New Files

| File | Description |
|------|-------------|
| `src/lib/engine/scheduler/types.ts` | Type definitions: `WeightProfile`, `AssignmentDraft`, `UnderstaffedShift`, `GenerationResult`, `SchedulerContext` |
| `src/lib/engine/scheduler/state.ts` | `SchedulerState` class: O(1) mutable tracking for rest hours, consecutive days, weekly hours, weekend counts |
| `src/lib/engine/scheduler/eligibility.ts` | `passesHardRules()` and `getRejectionReasons()` — 8 hard rule checks |
| `src/lib/engine/scheduler/scoring.ts` | `softPenalty()` — 7-component soft rule scoring |
| `src/lib/engine/scheduler/weight-profiles.ts` | `BALANCED`, `FAIR`, `COST_OPTIMIZED` weight profile constants |
| `src/lib/engine/scheduler/greedy.ts` | `greedyConstruct()` — greedy construction phase |
| `src/lib/engine/scheduler/local-search.ts` | `localSearch()` — swap-improvement phase |
| `src/lib/engine/scheduler/index.ts` | Entry point: `buildSchedulerContext()`, `generateSchedule()` |
| `src/lib/engine/scheduler/runner.ts` | `runGenerationJob()` — orchestrates 3 variants, writes DB, logs audit |
| `src/app/api/scenarios/generate/status/route.ts` | **NEW** `GET /api/scenarios/generate/status` — job progress polling endpoint |
| `src/__tests__/scheduler/state.test.ts` | **NEW** — 31 tests for `SchedulerState` |
| `src/__tests__/scheduler/eligibility.test.ts` | **NEW** — 28 tests for hard rule eligibility checks |
| `src/__tests__/scheduler/scoring.test.ts` | **NEW** — 17 tests for soft penalty scoring |
| `src/__tests__/scheduler/greedy.test.ts` | **NEW** — 11 tests for greedy construction |
| `src/__tests__/scheduler/local-search.test.ts` | **NEW** — 7 tests for local search improvement |

### Modified Files

| File | Change |
|------|--------|
| `src/db/schema.ts` | Added `generation_job` table; new audit actions (`schedule_auto_generated`, `scenario_applied`); new assignment source `scenario_applied` |
| `src/app/api/scenarios/generate/route.ts` | Replaced stub with background job: validates schedule, rejects duplicate jobs (409), creates `generation_job` record, fires `setImmediate` |
| `src/app/api/scenarios/[id]/route.ts` | Added `apply` action to `PUT` handler: deletes existing assignments, inserts snapshot, marks scenario selected, logs audit |
| `src/app/scenarios/page.tsx` | Added polling progress bar, understaffed warnings panel, Apply/Reject buttons per scenario, `scheduleId` query param auto-selection |
| `src/app/schedule/[id]/page.tsx` | Added "Generate Schedule" button navigating to Scenarios page with pre-selected schedule |

---

## [1.3.3] - 2026-02-19

### Summary

This release fixes two silent rule engine bugs discovered during test suite development, and establishes a comprehensive unit test suite (108 tests) as the foundation for ongoing rule correctness verification. Both bugs caused incorrect rule evaluations that went undetected in production.

---

### Bug Fix 1: Med-Surg Shifts Incorrectly Triggered Level 2 Supervision Rule

#### The Problem

Rule 8 (Level 2 ICU/ER Supervision) is supposed to fire only for ICU, ER, and ED units. The rule checked whether the unit name *contained* a supervised unit keyword using JavaScript's `String.includes()`. Because `"MED-SURG".includes("ED")` evaluates to `true` (the string "ED" is a substring of "MED"), any shift on a Med-Surg unit was incorrectly flagged as requiring a Level 4+ supervisor when a Level 2 nurse was assigned.

This meant Level 2 nurses were being shown false violations on Med-Surg shifts — a unit they are fully qualified to work independently.

#### The Solution

The matching logic was changed from substring matching to exact word matching. The unit name is now split into individual words (on spaces, hyphens, and underscores), and each word is compared exactly against the supervised-unit list (`ICU`, `ER`, `ED`, `EMERGENCY`). A unit named "Med-Surg" produces the words `["MED", "SURG"]` — neither matches — so the rule correctly does not fire.

---

### Bug Fix 2: Same-Weekend Saturday/Sunday Counted as Two Consecutive Weekends

#### The Problem

Rule 3 in the soft rules (Consecutive Weekends) tracks how many weekends in a row a staff member works. A "weekend ID" was computed by converting the shift date to a week number. Because week numbers change between Saturday and Sunday (Saturday is the last day of one ISO week, Sunday is the first of the next), a staff member working both Saturday and Sunday of the **same** weekend received two different weekend IDs.

This made one calendar weekend count as two consecutive weekends, falsely triggering the "more than 2 consecutive weekends" penalty whenever a staff member worked a full weekend.

#### The Solution

The `getWeekendId()` function was updated so that Sundays are shifted back by one day to their preceding Saturday before the week number is calculated. This ensures Saturday Feb 7 and Sunday Feb 8 both produce the same weekend ID (`2026-W6`), correctly treating them as one weekend.

---

### New: Unit Test Suite

A comprehensive Vitest unit test suite was added covering all 13 hard rules and 8 soft rules. Tests run without a database connection — rule evaluators are pure functions that receive a `RuleContext` object, making them fully testable in isolation.

**Coverage:**
- 108 tests across 12 test files
- All rule evaluators tested with passing, failing, and edge-case scenarios
- Two test-driven bugs discovered and fixed (see above)

**Running tests:**
```bash
npm test        # Run all tests once
npm run test:watch   # Watch mode
```

---

### Files Modified

| File | Change |
|------|--------|
| `src/lib/engine/rules/competency-pairing.ts` | Changed unit name matching from substring to exact word matching to fix Med-Surg false positives |
| `src/lib/engine/rules/weekend-holiday-fairness.ts` | Fixed `getWeekendId()` to shift Sunday back to Saturday before computing week number |
| `src/db/schema.ts` | No changes |
| `vitest.config.ts` | **NEW** - Vitest configuration with `vite-tsconfig-paths` for `@/*` alias support |
| `src/__tests__/helpers/context.ts` | **NEW** - Shared test helper factory functions for `RuleContext` mocks |
| `src/__tests__/rules/min-staff.test.ts` | **NEW** - 7 tests for minimum staff rule |
| `src/__tests__/rules/charge-nurse.test.ts` | **NEW** - 6 tests for charge nurse requirement |
| `src/__tests__/rules/patient-ratio.test.ts` | **NEW** - 7 tests for patient-to-staff ratio |
| `src/__tests__/rules/rest-hours.test.ts` | **NEW** - 7 tests for minimum rest between shifts |
| `src/__tests__/rules/max-consecutive.test.ts` | **NEW** - 6 tests for maximum consecutive days |
| `src/__tests__/rules/icu-competency.test.ts` | **NEW** - 5 tests for ICU competency minimum |
| `src/__tests__/rules/competency-pairing.test.ts` | **NEW** - 10 tests for competency pairing (Level 1 preceptor + Level 2 supervision) |
| `src/__tests__/rules/no-overlapping-shifts.test.ts` | **NEW** - 6 tests for overlapping shifts |
| `src/__tests__/rules/prn-availability.test.ts` | **NEW** - 12 tests for PRN availability |
| `src/__tests__/rules/on-call-limits.test.ts` | **NEW** - 8 tests for on-call limits |
| `src/__tests__/rules/overtime-v2.test.ts` | **NEW** - 7 tests for overtime rule |
| `src/__tests__/rules/soft-rules.test.ts` | **NEW** - 27 tests for all 8 soft rules |
| `package.json` | Added `test` and `test:watch` scripts; added `vitest`, `vite-tsconfig-paths`, `@vitest/ui` devDependencies |
| `RULES_SPECIFICATION.md` | Updated to v1.2.4; Rule 3.8 updated with word-boundary matching note; Rule 4.3 updated with weekend definition |

---

### Impact

These were silent bugs — they produced incorrect violation flags without crashing. Any schedule with:
- Level 2 nurses on Med-Surg shifts (Bug 1)
- Staff working both days of a weekend (Bug 2)

...would have shown spurious rule violations in the UI. No data was corrupted; only the displayed violation state was incorrect.

---

## [1.3.2] - 2026-02-18

### Summary

This release adds **staff scheduling preferences** to the Excel import/export feature. Staff preferences (shift preference, days off, consecutive days, etc.) can now be managed via Excel spreadsheet, enabling bulk updates and easier initial setup.

---

### New Feature: Staff Preferences in Excel

#### The Problem

Staff preferences were only editable through the UI one person at a time. For hospitals with 30+ staff members, setting up everyone's preferred shifts, days off, and work limits was time-consuming.

#### The Solution

Staff preferences are now included in the Excel export/import. Managers can:

1. **Export current data** - Preferences are included in the Staff sheet
2. **Edit in Excel** - Update preferences for multiple staff at once
3. **Import** - All preferences are saved along with staff data

---

### New Excel Columns in Staff Sheet

| Column | Values | Default | Description |
|--------|--------|---------|-------------|
| Preferred Shift | day, night, evening, any | any | Which shift type the staff prefers |
| Preferred Days Off | Comma-separated days | (empty) | Days staff prefers not to work (e.g., "Saturday, Sunday") |
| Max Consecutive Days | 1-7 | 3 | Maximum days in a row before requiring a day off |
| Max Hours Per Week | 8-60 | 40 | Maximum scheduled hours per week |
| Avoid Weekends | Yes / No | No | Soft preference to avoid weekend shifts |

---

### How It Works

#### Export
When downloading current data, each staff row now includes their preference settings in the new columns.

#### Import
When uploading an Excel file:
- Preference columns are parsed with flexible column name matching
- Invalid values fall back to defaults (e.g., "morning" → "any")
- Days are normalized to proper capitalization ("saturday" → "Saturday")
- Preferences are saved to the `staff_preferences` table

#### Template
The downloadable template now includes example preference values:
```
Preferred Shift: day
Preferred Days Off: Saturday, Sunday
Max Consecutive Days: 4
Max Hours Per Week: 40
Avoid Weekends: No
```

---

### Validation

**Preferred Shift:**
- Must be: `day`, `night`, `evening`, or `any`
- Case-insensitive ("Day" and "DAY" both work)
- Invalid values default to `any`

**Preferred Days Off:**
- Comma-separated day names
- Valid days: Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday
- Case-insensitive
- Invalid day names are ignored

**Max Consecutive Days:**
- Must be between 1 and 7
- Non-numeric values default to 3

**Max Hours Per Week:**
- Must be between 8 and 60
- Non-numeric values default to 40

**Avoid Weekends:**
- Accepts: Yes, No, True, False, 1, 0
- Case-insensitive

---

### Files Modified

| File | Change |
|------|--------|
| `src/lib/import/parse-excel.ts` | Added preference fields to `StaffImport` interface; parse preference columns in `parseStaffSheet()`; added preference columns to `generateTemplate()` |
| `src/app/api/import/route.ts` | Query and export staff preferences; use imported preferences instead of defaults on import |
| `docs/09-using-the-app.md` | Documented new preference columns |
| `RULES_SPECIFICATION.md` | Updated to v1.2.3 with changelog entry |

---

### Integration with Scheduling Rules

The imported preferences integrate with existing scheduling rules:

- **preference-match** (soft rule) - Penalizes assignments that don't match preferred shift type or days off
- **max-consecutive** (hard rule) - Enforces the max consecutive days setting
- **weekend-count** (soft rule) - Considers avoid weekends preference

---

### Example Workflow

1. **Export** current staff data from Setup page
2. **Open** the Excel file
3. **Add/update** preference columns:
   - Set Maria to prefer day shifts
   - Set John to avoid weekends
   - Set all PRN staff to max 2 consecutive days
4. **Upload** the modified file
5. **Import** - preferences are saved for all staff
6. **Generate schedule** - rules engine uses the new preferences

---

## [1.3.1] - 2026-02-16

### Summary

This release addresses expert feedback on census visibility, staff count display, and preferences visibility.

---

### Changes

#### 1. Census Management
- **Census input** added to shift assignment dialog - managers can now set patient census per shift
- **Census determines staffing** - required staff count is calculated from census bands based on actual patient count
- **Audit logging** - census changes are logged to the audit trail
- **Excel support** - Census Bands sheet added to Excel import/export

#### 2. Staff Count Display Fix
- Previously showed `3/3 staff` even when census bands required 4
- Now correctly shows `3/4 staff` (scheduled/required) based on census band calculations
- API calculates effective required count: `max(shift definition, census band requirement)`

#### 3. Staff Preferences Visibility
- Staff detail dialog now shows **Shift Preferences** section
- Displays: Preferred Shift, Max Hours/Week, Max Consecutive Days, Preferred Days Off, Avoid Weekends, Notes
- Preferences are fetched when dialog opens

#### 4. Census Bands in Excel
- New **Census Bands** sheet in Excel export
- Columns: Name, Unit, Min/Max Patients, Required RNs/LPNs/CNAs, Required Charge, Ratio
- Import census bands to configure staffing requirements per patient count
- If no Census Bands sheet provided, defaults are created

---

### Files Changed
- `src/app/api/schedules/[id]/route.ts` - Calculate effective required from census
- `src/app/api/shifts/[id]/acuity/route.ts` - Support census updates
- `src/components/schedule/assignment-dialog.tsx` - Add census input
- `src/components/staff/staff-detail-dialog.tsx` - Show preferences
- `src/lib/import/parse-excel.ts` - Parse Census Bands sheet
- `src/app/api/import/route.ts` - Import/export census bands
- `src/db/schema.ts` - Add `census_changed` action type

---

## [1.3.0] - 2026-02-15

### Summary

This release adds an **Excel Import/Export** feature that allows hospitals to manage their data via spreadsheets. Users can export current data, edit in Excel, and re-import - making bulk updates simple. This also enables first-time setup by filling in an exported template.

---

### New Feature: Excel Data Import

#### The Problem

Hospitals typically have their staff information stored in Excel spreadsheets. Manually entering 30+ staff members through the UI is time-consuming and error-prone.

#### The Solution

A new **Setup** page (`/setup`) allows users to:

1. **Export current data** - Download an Excel file with current Staff, Units, and Holidays
2. **Edit in Excel** - Add, remove, or modify entries in the familiar spreadsheet format
3. **Upload and validate** - System checks for errors before importing
4. **Import with one click** - Replaces existing data with the uploaded file

This creates a seamless **Export → Edit → Import** workflow for bulk data management.

---

### Excel File Format

**Sheet 1: Staff**
| Column | Required | Example |
|--------|----------|---------|
| First Name | Yes | Maria |
| Last Name | Yes | Garcia |
| Role | Yes | RN / LPN / CNA |
| Employment Type | Yes | full_time / part_time / per_diem / float / agency |
| FTE | No | 1.0 (default) |
| Home Unit | No | ICU |
| Cross-Trained Units | No | ER, Med-Surg (comma-separated) |
| Competency Level | No | 1-5 (default 3) |
| Charge Nurse Qualified | No | Yes / No |
| Reliability Rating | No | 1-5 (default 3) |
| Email | No | email@hospital.com |
| Phone | No | 555-0101 |
| Hire Date | No | YYYY-MM-DD |
| Weekend Exempt | No | Yes / No |
| VTO Available | No | Yes / No |
| Notes | No | Free text |

**Sheet 2: Units**
| Column | Required | Example |
|--------|----------|---------|
| Name | Yes | ICU |
| Description | No | Intensive Care Unit |
| Min Staff Day | Yes | 4 |
| Min Staff Night | Yes | 3 |
| Weekend Shifts Required | No | 3 (default) |
| Holiday Shifts Required | No | 1 (default) |

**Sheet 3: Holidays**
| Column | Required | Example |
|--------|----------|---------|
| Name | Yes | Christmas Day |
| Date | Yes | 2026-12-25 |

---

### How It Works

#### Step 1: Export Current Data
- Click "Download Data" on the Setup page
- Downloads Excel file with your current Staff, Units, and Holidays
- First-time users get headers only (empty database)

#### Step 2: Edit in Excel
- Add new rows, remove rows, or modify existing entries
- Required fields must be filled
- Optional fields can be left blank (defaults applied)

#### Step 3: Upload and Validate
- Drag and drop or click to upload
- System parses and validates every row
- Shows preview with counts:
  - "28 Staff, 3 Units, 9 Holidays"
- Displays any errors (must be fixed) or warnings (informational)

#### Step 4: Import
- Click "Import Data"
- Confirmation dialog warns about data deletion
- System deletes ALL existing data
- Imports new data from Excel
- Auto-creates: shift definitions, rules, census bands

---

### What Gets Imported

**From Excel:**
- Staff members (with auto-created preferences)
- Units (with default configuration)
- Holidays

**Auto-Generated Defaults:**
- Day Shift (7am-7pm, 12 hours)
- Night Shift (7pm-7am, 12 hours)
- 21 scheduling rules (13 hard, 8 soft)
- Census bands for first unit

---

### Validation

**Errors (block import):**
- Missing required fields (First Name, Last Name, Role, etc.)
- Invalid enum values (e.g., "Nurse" instead of "RN")
- Invalid numbers (e.g., FTE > 1.0)

**Warnings (informational):**
- Missing optional fields (e.g., no email)
- Missing sheets (e.g., no Holidays sheet)

---

### Files Added

| File | Purpose |
|------|---------|
| `src/app/setup/page.tsx` | Setup page with upload UI |
| `src/app/api/import/route.ts` | API for file processing |
| `src/lib/import/parse-excel.ts` | Excel parsing and validation |

### Files Modified

| File | Change |
|------|--------|
| `src/components/layout/sidebar.tsx` | Added "Setup" link |
| `package.json` | Added `xlsx` dependency |

---

### Dependencies Added

```
xlsx: ^0.18.5
```

The `xlsx` (SheetJS) library handles Excel file parsing in the browser and server.

---

## [1.2.1] - 2026-02-15

### Summary

This release corrects the leave approval workflow based on expert feedback from Pradeep. The key change is that the system now **automatically finds and recommends replacement candidates** instead of creating open shifts that wait for manual assignment.

---

### What Changed: Coverage Auto-Fill Workflow

#### The Problem with v1.2.0

In v1.2.0, when leave was approved more than 7 days before a shift, the system created an "Open Shift" record. The manager then had to:
1. Go to the Open Shifts page
2. Manually search for available staff
3. Evaluate each candidate
4. Assign someone

This was still a manual, time-consuming process.

#### The Solution in v1.2.1

Now, when leave is approved more than 7 days before a shift:

1. **System automatically searches** for replacement candidates
2. **Follows the escalation ladder**: Float Pool → PRN → Overtime → Agency
3. **Ranks candidates** by suitability (qualifications, availability, fairness)
4. **Presents top 3 candidates** with explanatory reasons
5. **Manager reviews and clicks "Approve"**
6. **Assignment is created automatically**

---

### How the Candidate Finding Algorithm Works

The new `findCandidatesForShift()` function in `src/lib/coverage/find-candidates.ts`:

#### Step 1: Check Float Pool Staff
- Queries all active float pool staff
- Checks each for availability on the shift date
- Verifies they're qualified for the unit (home unit or cross-trained)
- Calculates hours this week to determine overtime

#### Step 2: Check PRN Staff
- Queries all active PRN (per diem) staff
- Only considers those who **marked this date as available**
- Verifies unit qualification
- Checks all scheduling rules (rest time, 60-hour limit, etc.)

#### Step 3: Check Regular Staff for Overtime
- Queries full-time and part-time staff
- Identifies those not already scheduled
- Calculates if this would push them into overtime (>40 hours)
- Considers flex hours YTD for fairness

#### Step 4: Agency Option
- Always included as a fallback
- Marked as "requires external contact"
- Lowest priority score (last resort)

#### Ranking Criteria

Each candidate receives a score based on:

| Factor | Score Impact |
|--------|--------------|
| **Source Priority** | Float (100) > PRN (80) > OT (60) > Agency (10) |
| **Unit Match** | Home unit (+10) > Cross-trained (+0) |
| **Competency Level** | Higher level = higher score |
| **Reliability Rating** | 5/5 = +15, 1/5 = +3 |
| **Overtime** | Non-OT preferred (+15 if within 40h) |
| **Flex Hours YTD** | Lower flex hours = higher score (fairness) |

#### Reasons Provided

Each candidate includes human-readable reasons. Examples:

**Float Pool Candidate:**
- "Float pool staff - designed for coverage"
- "Cross-trained for ICU"
- "Competency Level 4 (Proficient)"
- "Reliability rating: 5/5"

**PRN Candidate:**
- "PRN staff - marked available for this date"
- "Home unit is ICU"
- "High reliability rating (4/5)"

**Overtime Candidate:**
- "Would be overtime (OT pay applies)"
- "Cross-trained for ICU"
- "Low flex hours YTD (fair distribution)"

---

### UI Changes

#### Sidebar Navigation
- Renamed: "Open Shifts" → **"Coverage"**
- Same URL: `/open-shifts`

#### Coverage Page (`/open-shifts`)

**Before (v1.2.0):**
- Table with open shifts
- "Fill" button opened a dialog to manually select staff
- No recommendations

**After (v1.2.1):**
- Table shows pending coverage requests
- "Top Recommendation" column shows best candidate
- "Review" button opens detailed view with top 3 candidates
- Each candidate shows:
  - Name and source (Float Pool, PRN, Overtime, Agency)
  - Color-coded badge (blue for Float, green for PRN, etc.)
  - List of reasons with checkmarks
  - Hours this week + overtime indicator
- "Approve" button next to each candidate
- Clicking "Approve" creates the assignment automatically

---

### Database Schema Changes

**Modified `open_shift` table:**

| New Column | Type | Purpose |
|------------|------|---------|
| `recommendations` | JSON | Stores top 3 candidates with reasons |
| `escalation_steps_checked` | JSON | Array of sources checked (e.g., ["float", "per_diem", "overtime"]) |
| `selected_staff_id` | TEXT | Staff ID chosen by manager |
| `selected_source` | TEXT | Source of chosen staff (float, per_diem, overtime, agency) |
| `approved_at` | TEXT | Timestamp of approval |
| `approved_by` | TEXT | Who approved |

**Modified `status` enum:**
- Old: `open`, `filled`, `cancelled`
- New: `pending_approval`, `approved`, `filled`, `cancelled`, `no_candidates`

---

### API Changes

#### `PUT /api/open-shifts/[id]`

**New action: `approve`**

```json
{
  "action": "approve",
  "selectedStaffId": "staff-uuid-here"
}
```

Response:
- Creates assignment automatically
- Updates coverage request status to "filled"
- Logs audit trail entry

---

### Files Added/Modified

| File | Change |
|------|--------|
| `src/lib/coverage/find-candidates.ts` | **NEW** - Candidate finding algorithm |
| `src/db/schema.ts` | Added new fields to `open_shift` table |
| `src/app/api/staff-leave/[id]/route.ts` | Calls `findCandidatesForShift()` on approval |
| `src/app/api/open-shifts/route.ts` | Returns recommendation fields |
| `src/app/api/open-shifts/[id]/route.ts` | Added `approve` action |
| `src/app/open-shifts/page.tsx` | Complete rewrite for approval workflow |
| `src/components/layout/sidebar.tsx` | Renamed to "Coverage" |

---

### Testing the New Workflow

1. **Create a staff member with scheduled shifts** (at least 8+ days out)
2. **Approve leave** that covers one of those shift dates
3. **Go to Coverage page** (`/open-shifts`)
4. **Verify** the request shows "Pending Approval" status
5. **Click "Review"** to see top 3 candidates with reasons
6. **Click "Approve"** on your chosen candidate
7. **Verify** the assignment was created in the schedule

---

## [1.2.0] - 2026-02-15

### Overview

This release implements 5 major features based on expert feedback from field testing. These changes improve holiday fairness tracking, low census management, shift visibility, leave workflow integration, and staff schedule viewing.

---

### New Features

#### 1. Open Shifts Page (`/open-shifts`)

A new page for managing shifts that need coverage due to leave approvals or callouts.

**What it does:**
- Displays all shifts needing coverage in a filterable table
- Shows shift details: date, time, unit, original staff, reason, priority
- Filter tabs: Open, Filled, Cancelled, All
- "Fill" action opens a dialog to assign a replacement staff member
- "Cancel" action removes the open shift from the queue
- Automatically creates assignments when shifts are filled
- Full audit trail integration for all actions

**Why it matters:**
- Provides a centralized view of all coverage needs
- Streamlines the process of finding and assigning replacements
- Connects leave approvals to operational coverage needs

**Files:**
- `src/app/open-shifts/page.tsx` - Main page component
- `src/app/api/open-shifts/route.ts` - GET/POST endpoints
- `src/app/api/open-shifts/[id]/route.ts` - GET/PUT/DELETE endpoints
- `src/components/layout/sidebar.tsx` - Navigation link added

---

#### 2. Staff Calendar View

Clicking a staff member's name now opens a calendar showing their day-by-day schedule.

**What it does:**
- Calendar grid displays the current month with navigation
- Color-coded days:
  - **Blue** - Day shift assigned
  - **Purple** - Night shift assigned
  - **Green** - On approved leave
  - **Gray** - Off / not scheduled
- Shows staff summary: role, employment type, home unit, FTE
- Default view: current schedule period
- Click arrows to navigate months

**Why it matters:**
- Quickly see a staff member's complete schedule at a glance
- Identify coverage gaps and overwork patterns
- Understand staff availability before making assignments

**Files:**
- `src/components/staff/staff-calendar.tsx` - Calendar component
- `src/components/staff/staff-detail-dialog.tsx` - Dialog wrapper
- `src/app/api/staff/[id]/schedule/route.ts` - Schedule data API
- `src/components/staff/staff-table.tsx` - Name click handler
- `src/app/staff/page.tsx` - Dialog state management

---

#### 3. Shift Violations Modal

The issues badge on shifts is now clickable, showing detailed violation information.

**What it does:**
- Click the red badge on any shift to see violation details
- Modal displays violations in two sections:
  - **Hard Rule Violations** (red) - Must be fixed before publishing
  - **Soft Rule Violations** (yellow) - Preferences/penalties that can be overridden
- Each violation shows:
  - Rule name
  - Description of the issue
  - Penalty score (for soft violations)
- Click on shift cell still opens assignment dialog (unchanged behavior)

**Why it matters:**
- Managers can understand exactly what's wrong with a shift
- Distinguishes between critical issues and minor preferences
- Helps prioritize which problems to address first

**Files:**
- `src/components/schedule/shift-violations-modal.tsx` - Modal component
- `src/components/schedule/schedule-grid.tsx` - Badge click handler
- `src/app/schedule/[id]/page.tsx` - Modal state and violation data

---

### Changed Features

#### 4. Leave Approval Workflow - Now Creates Open Shifts/Callouts

When leave is approved, the system now automatically handles affected shifts.

**What it does:**
- When leave is approved, finds all assignments during the leave period
- For each affected shift:
  - If shift is **within threshold** (default: 7 days) → Creates a **Callout** (urgent)
  - If shift is **beyond threshold** → Creates an **Open Shift** (for scheduled pickup)
- Original assignments are automatically cancelled
- Full audit trail of all changes

**Configuration:**
- `calloutThresholdDays` setting on Unit configuration (default: 7)
- Can be customized per unit

**Why it matters:**
- Eliminates manual step of creating callouts after approving leave
- Ensures no shifts are forgotten when approving time off
- Distinguishes between urgent last-minute needs and advance planning

**Files:**
- `src/app/api/staff-leave/[id]/route.ts` - Enhanced with `handleLeaveApproval()`
- `src/db/schema.ts` - Added `calloutThresholdDays` to unit table

---

#### 5. Holiday Fairness - Now Tracks Annually

Holiday assignment tracking has been changed from per-schedule-period to annual tracking.

**What it does:**
- New `staff_holiday_assignment` table tracks all holiday assignments across the year
- Fairness evaluation compares each staff member's yearly total against the average
- Christmas Eve and Christmas Day are now grouped as ONE "Christmas" holiday
  - Working either day counts as "worked Christmas"
  - Prevents double-counting during evaluation

**Why it matters:**
- Fairer distribution over longer time periods
- Staff who worked holidays early in the year get recognition all year
- Christmas tracking is more realistic (most people work Eve OR Day, not both)

**Files:**
- `src/db/schema.ts` - Added `staff_holiday_assignment` table
- `src/lib/engine/rules/weekend-holiday-fairness.ts` - Rewritten with annual logic and `HOLIDAY_GROUPS`
- `src/app/api/schedules/[id]/assignments/route.ts` - Tracks holiday assignments on create/delete

**Holiday Groups:**
```typescript
const HOLIDAY_GROUPS: Record<string, string> = {
  "Christmas Eve": "Christmas",
  "Christmas Day": "Christmas",
};
```

---

#### 6. Low Census Order - Removed Agency, Added VTO

The low census priority order has been updated based on operational feedback.

**Previous Order:**
1. Agency (removed - contracts guarantee hours)
2. Overtime
3. Per Diem
4. Full Time

**New Order:**
1. **Voluntary (VTO)** - Staff who opted in for voluntary time off
2. Overtime
3. Per Diem
4. Full Time

**New Staff Attribute:**
- `voluntaryFlexAvailable` (boolean) - Staff can indicate they're willing to go home voluntarily
- Displayed as "VTO" badge on staff table
- Configurable in staff edit form

**Why it matters:**
- Agency staff have contracts guaranteeing minimum hours - sending them home doesn't save money
- Voluntary time off respects staff preferences while meeting operational needs
- Staff appreciate choice in low census situations

**Files:**
- `src/db/schema.ts` - Added `voluntaryFlexAvailable` to staff table
- `src/db/seed.ts` - Updated default low census order
- `src/app/settings/units/page.tsx` - Updated UI default
- `src/components/staff/staff-form.tsx` - Added VTO checkbox
- `src/components/staff/staff-table.tsx` - Added VTO badge
- `src/types/staff.ts` - Added field to type
- `src/app/api/staff/route.ts` - Handle VTO field
- `src/app/api/staff/[id]/route.ts` - Handle VTO field

---

### Database Schema Changes

#### New Tables

**`staff_holiday_assignment`**
```sql
CREATE TABLE staff_holiday_assignment (
  id TEXT PRIMARY KEY,
  staff_id TEXT NOT NULL REFERENCES staff(id),
  holiday_name TEXT NOT NULL,  -- "Christmas", "Thanksgiving", etc.
  year INTEGER NOT NULL,
  shift_id TEXT REFERENCES shift(id),
  assigned_at TEXT NOT NULL
);
```

**`open_shift`**
```sql
CREATE TABLE open_shift (
  id TEXT PRIMARY KEY,
  shift_id TEXT NOT NULL REFERENCES shift(id),
  original_staff_id TEXT NOT NULL REFERENCES staff(id),
  original_assignment_id TEXT REFERENCES assignment(id),
  reason TEXT NOT NULL,  -- "leave_approved", "callout", etc.
  reason_detail TEXT,
  status TEXT DEFAULT 'open',  -- "open", "filled", "cancelled"
  priority TEXT DEFAULT 'normal',  -- "low", "normal", "high", "urgent"
  created_at TEXT NOT NULL,
  filled_at TEXT,
  filled_by_staff_id TEXT REFERENCES staff(id),
  filled_by_assignment_id TEXT REFERENCES assignment(id),
  notes TEXT
);
```

#### Modified Tables

**`staff`**
- Added: `voluntary_flex_available` (boolean, default false)

**`unit`**
- Added: `callout_threshold_days` (integer, default 7)

**`exception_log`**
- Added entity types: `"open_shift"`, `"staff_holiday_assignment"`
- Added actions: `"open_shift_created"`, `"open_shift_filled"`, `"open_shift_cancelled"`, `"assignment_cancelled_for_leave"`, `"callout_created_for_leave"`

---

### UI Navigation Update

The sidebar now includes:
1. Dashboard
2. Staff
3. Schedule
4. Scenarios
5. Callouts
6. **Open Shifts** (NEW)
7. Leave
8. Shift Swaps
9. PRN Availability
10. Rules
11. Units
12. Holidays
13. Audit Trail

---

### Documentation Updates

- `RULES_SPECIFICATION.md` - Updated to version 1.2 with all changes
- `docs/05-scheduling-rules.md` - Updated holiday fairness section
- `docs/07-handling-callouts.md` - Added open shifts and VTO sections
- `docs/08-configuration.md` - Added new settings documentation
- `docs/09-using-the-app.md` - Added Open Shifts page and Staff Calendar
- `docs/10-glossary.md` - Added VTO, Open Shift terms

---

### Migration Notes

#### For Existing Deployments

1. **Database Migration Required**
   - New tables need to be created (`staff_holiday_assignment`, `open_shift`)
   - New columns need to be added to `staff` and `unit` tables
   - Run `npx drizzle-kit push` or apply migrations manually

2. **Low Census Order**
   - Existing units will keep their current `lowCensusOrder`
   - New units will use the updated default: `["voluntary", "overtime", "per_diem", "full_time"]`
   - Update existing units manually if desired

3. **Holiday Tracking**
   - Historical holiday assignments before this update are not tracked
   - Annual fairness tracking starts fresh from this deployment
   - First full year of data will establish baseline

4. **Staff VTO Setting**
   - All existing staff default to `voluntaryFlexAvailable = false`
   - Staff can update their preference via the staff form
   - Managers can update on behalf of staff

---

### Technical Details

**Dependencies:** No new dependencies added

**API Changes:**
- `GET /api/open-shifts` - List all open shifts with shift/staff details
- `POST /api/open-shifts` - Create new open shift
- `GET /api/open-shifts/[id]` - Get single open shift
- `PUT /api/open-shifts/[id]` - Fill or cancel open shift
- `DELETE /api/open-shifts/[id]` - Delete open shift
- `GET /api/staff/[id]/schedule` - Get staff schedule for date range
- `PUT /api/staff-leave/[id]` - Enhanced to auto-create open shifts/callouts

**Breaking Changes:** None

---

## [1.1.0] - 2026-02-13

### Added
- Section 11 (Application UI Guide) in RULES_SPECIFICATION.md
- Documentation for Leave Management, Shift Swaps, PRN Availability pages
- Documentation for Unit Configuration and Holidays Management pages

---

## [1.0.0] - 2026-02-01

### Added
- Initial release of CAH Scheduler
- Complete scheduling rule engine with hard and soft rules
- Staff management with competency levels
- Shift and assignment management
- Callout logging and escalation workflow
- Leave request management
- Shift swap functionality
- PRN availability tracking
- Unit configuration
- Holiday management
- Audit trail
- Scenario comparison

---

*For questions about this release, please open an issue on GitHub.*
